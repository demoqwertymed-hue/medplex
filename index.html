<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Medical Device Risk Assessment</title>
  <meta name="description" content="Assess medical device risks for hospitals and improve manufacturing quality" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/react-toastify@9.1.3/dist/ReactToastify.min.css" />
  <script src="/config.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'ui-sans-serif', 'system-ui'] },
          colors: {
            brand: {
              blue: '#1D4ED8',
              green: '#22C55E',
              red: '#EF4444',
              yellow: '#FBBF24',
              darkgreen: '#14532D',
              brown: '#854D0E',
              darkred: '#991B1B'
            }
          }
        }
      }
    }
  </script>
  <style>
    html, body, #root { height: 100%; }
    body { background: #F8FAFC; }
  </style>
</head>
<body class="font-sans text-gray-800">
  <div id="root"></div>

  <!-- React, Router, Axios, Chart.js, Toastify, DOMPurify, (optional) Framer Motion -->
  <script crossorigin src="https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.production.min.js"></script>
  <script crossorigin src="https://cdn.jsdelivr.net/npm/history@5/umd/history.production.min.js"></script>
  <script crossorigin src="https://cdn.jsdelivr.net/npm/react-router@6/umd/react-router.production.min.js"></script>
  <script crossorigin src="https://cdn.jsdelivr.net/npm/react-router-dom@6/umd/react-router-dom.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios@1.7.7/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.6/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-toastify@9.1.3/dist/ReactToastify.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.7/dist/purify.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/framer-motion@11.3.28/dist/framer-motion.umd.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone/babel.min.js"></script>

  <!-- Fallback no-JSX bundle (ensures app renders even if Babel fails) -->
  <script defer src="/app.js"></script>
  <!-- JSX build disabled, using app.js fallback -->
  <script type="text/babel-disabled" data-presets="env,react">
    const { useState, useEffect, useRef, useMemo, useContext, createContext } = React;
    const { HashRouter, Routes, Route, Link, useNavigate, Navigate, useLocation } = ReactRouterDOM;
    const { ToastContainer, toast } = ReactToastify;
    const API_BASE_URL = window.REACT_APP_API_URL || 'http://localhost:8000';

    // Simple sanitizer
    const sanitize = (val) => DOMPurify.sanitize(val, { ALLOWED_TAGS: [], ALLOWED_ATTR: [] }).trim();

    // Global auth helpers
    const getToken = () => localStorage.getItem('token');
    const setToken = (t) => localStorage.setItem('token', t);
    const clearToken = () => localStorage.removeItem('token');

    // Simple redirect helper usable outside React
    const redirectToLogin = () => { window.location.hash = '#/login'; };

    // Axios instance with interceptors
    const api = axios.create({ baseURL: API_BASE_URL, headers: { 'Content-Type': 'application/json' } });
    api.interceptors.request.use((config) => {
      const token = getToken();
      if (token) config.headers.Authorization = `Bearer ${token}`;
      return config;
    });
    api.interceptors.response.use(
      (resp) => resp,
      (error) => {
        const status = error?.response?.status;
        if (status === 401) {
          clearToken();
          toast.error('Session expired. Please login again.');
          redirectToLogin();
        } else if (status === 403) {
          toast.error('You do not have permission to perform this action.');
        } else if (status >= 500) {
          toast.error('Server error. Please try again later.');
        }
        return Promise.reject(error);
      }
    );

    // Mock backend fallback for demo/testing without FastAPI running
    const createMockBackend = () => {
      const now = new Date().toISOString();
      let devices = [
        { _id: 'd1', device_name: 'CardioMon 3000', manufacturer_name: 'MediTech', risk_class: 'Low', risk_percent: 12.5, suggested_alternatives: ['CardioMon 2000'], source: 'mock', username: 'alice', created_at: now },
        { _id: 'd2', device_name: 'NeuroScan X', manufacturer_name: 'NeuroCorp', risk_class: 'High', risk_percent: 78.9, suggested_alternatives: ['NeuroScan Lite'], source: 'mock', username: 'bob', created_at: now },
        { _id: 'd3', device_name: 'UltraSound Pro', manufacturer_name: 'SonoLabs', risk_class: 'Medium', risk_percent: 43.1, suggested_alternatives: ['UltraSound Mini'], source: 'mock', username: 'alice', created_at: now },
      ];
      let currentPrediction = null;

      const predictRisk = ({ device_name, manufacturer_name, username }) => {
        const name = `${device_name} ${manufacturer_name}`.toLowerCase();
        let probs = { Low: 30, Medium: 40, High: 30 };
        if (name.includes('x')) probs = { Low: 10, Medium: 20, High: 70 };
        if (name.includes('pro')) probs = { Low: 55, Medium: 30, High: 15 };
        const entries = Object.entries(probs).sort((a,b)=>b[1]-a[1]);
        const top = entries[0][0];
        const percent = entries[0][1];
        const _id = `mock-${Math.random().toString(36).slice(2,9)}`;
        const res = {
          _id,
          device_name,
          manufacturer_name,
          risk_class: top,
          risk_percent: percent,
          probabilities: probs,
          suggested_alternatives: ['Alt A', 'Alt B'],
          username: username || 'mock-user',
          created_at: new Date().toISOString(),
        };
        devices = [{...res}, ...devices];
        currentPrediction = res;
        return Promise.resolve({ data: res });
      };

      return {
        health: () => Promise.resolve({ data: { status: 'ok' } }),
        register: (payload, isManufacturer=false) => Promise.resolve({ data: { message: 'Registered', role: isManufacturer ? 'manufacturer' : 'user' } }),
        login: (payload, isManufacturer=false) => Promise.resolve({ data: { access_token: 'mock-token', token_type: 'bearer', role: isManufacturer ? 'manufacturer' : 'user', username: payload.get ? payload.get('username') : 'user', company_name: isManufacturer ? 'MockCo' : undefined } }),
        devices: () => Promise.resolve({ data: devices }),
        deviceById: (id) => Promise.resolve({ data: devices.find(d=>d._id===id) || null }),
        predict: (payload) => predictRisk(payload),
        feedback: (device_id, payload) => Promise.resolve({ data: { message: 'Feedback received', device_id } }),
        modelInfo: () => Promise.resolve({ data: { version: 'mock-1.0' } }),
        getLastPrediction: () => currentPrediction,
      };
    };

    const BackendContext = createContext(null);

    function BackendProvider({ children }) {
      const [backend, setBackend] = useState(null);
      const [ready, setReady] = useState(false);

      useEffect(() => {
        (async () => {
          try {
            await api.get('/health');
            setBackend({
              health: () => api.get('/health'),
              register: (payload, isManufacturer=false) => api.post(isManufacturer ? '/register/manufacturer' : '/register', payload),
              login: (formData, isManufacturer=false) => axios.post(
                `${API_BASE_URL}${isManufacturer ? '/login/manufacturer' : '/login'}`,
                formData,
                { headers: { 'Content-Type': 'application/x-www-form-urlencoded' } }
              ),
              devices: () => api.get('/devices'),
              deviceById: (id) => api.get(`/devices/${encodeURIComponent(id)}`),
              predict: (payload) => api.post('/predict', payload),
              feedback: (device_id, payload) => api.post(`/feedback/${encodeURIComponent(device_id)}`, payload),
              modelInfo: () => api.get('/model_info'),
              getLastPrediction: () => null,
            });
          } catch (e) {
            const mock = createMockBackend();
            toast.info('Backend not reachable. Running in mock mode.');
            setBackend(mock);
          } finally {
            setReady(true);
          }
        })();
      }, []);

      if (!ready || !backend) return <div className="flex items-center justify-center h-screen text-brand-blue">Loading...</div>;
      return <BackendContext.Provider value={backend}>{children}</BackendContext.Provider>;
    }

    const useBackend = () => useContext(BackendContext);

    const AuthContext = createContext(null);

    function AuthProvider({ children }) {
      const [user, setUser] = useState(() => {
        try {
          const raw = localStorage.getItem('user');
          return raw ? JSON.parse(raw) : null;
        } catch { return null; }
      });

      const login = ({ token, role, username, company_name }) => {
        if (token) setToken(token);
        const u = { role, username, company_name };
        localStorage.setItem('user', JSON.stringify(u));
        setUser(u);
      };

      const logout = () => {
        clearToken();
        localStorage.removeItem('user');
        setUser(null);
      };

      return <AuthContext.Provider value={{ user, login, logout }}>{children}</AuthContext.Provider>;
    }

    const useAuth = () => useContext(AuthContext);

    function Header() {
      const { user, logout } = useAuth();
      const navigate = useNavigate();
      const handleLogout = () => {
        logout();
        toast.success('Logged out');
        navigate('/login');
      };
      return (
        <header className="bg-white/90 backdrop-blur border-b border-gray-100 sticky top-0 z-30">
          <div className="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
            <Link to="/" className="flex items-center gap-3">
              <div className="w-10 h-10 rounded-full bg-brand-blue text-white flex items-center justify-center font-bold">MD</div>
              <div>
                <h1 className="text-lg md:text-xl font-semibold text-brand-blue">Medical Device Risk Assessment</h1>
                <p className="text-xs text-gray-500">Assess risks. Improve quality.</p>
              </div>
            </Link>
            <nav className="flex items-center gap-3 md:gap-6">
              <Link className="text-sm text-gray-700 hover:text-brand-blue" to="/">Home</Link>
              {user?.role === 'user' && (
                <>
                  <Link className="text-sm text-gray-700 hover:text-brand-blue" to="/medical-dashboard">Medical Dashboard</Link>
                  <Link className="text-sm text-gray-700 hover:text-brand-blue" to="/device-risk-checker">Risk Checker</Link>
                </>
              )}
              {user?.role === 'manufacturer' && (
                <>
                  <Link className="text-sm text-gray-700 hover:text-brand-blue" to="/manufacturer-dashboard">Manufacturer Dashboard</Link>
                </>
              )}
              {!user && (
                <>
                  <Link className="px-3 py-1.5 rounded-md text-sm text-brand-blue hover:bg-blue-50" to="/login">Login</Link>
                  <Link className="px-3 py-1.5 rounded-md text-sm bg-brand-green text-white hover:bg-green-600" to="/register">Register</Link>
                </>
              )}
              {user && (
                <button onClick={handleLogout} className="px-3 py-1.5 rounded-md text-sm bg-gray-100 hover:bg-gray-200 text-gray-700">Logout</button>
              )}
            </nav>
          </div>
        </header>
      );
    }

    function Footer() {
      return (
        <footer className="mt-16 border-t border-gray-200 bg-white">
          <div className="max-w-7xl mx-auto px-4 py-6 text-sm text-gray-500 flex flex-col md:flex-row items-center justify-between gap-2">
            <p>© {new Date().getFullYear()} MedRisk. All rights reserved.</p>
            <p className="text-xs">Built with React, Tailwind CSS, Chart.js</p>
          </div>
        </footer>
      );
    }

    function Landing() {
      const { motion } = window['framer-motion'] || {};
      return (
        <div>
          <section className="bg-gradient-to-br from-blue-50 to-green-50">
            <div className="max-w-7xl mx-auto px-4 py-16 grid md:grid-cols-2 gap-10 items-center">
              <div>
                <h2 className="text-3xl md:text-4xl font-bold text-brand-blue">Assess medical device risks for hospitals and improve manufacturing quality</h2>
                <p className="mt-4 text-gray-700">A unified platform for medical users and manufacturers to evaluate device risk, visualize insights, and reduce faults.</p>
                <div className="mt-6 flex gap-3">
                  <Link to="/login" className="px-5 py-2.5 rounded-md bg-brand-blue text-white hover:bg-blue-700">Login</Link>
                  <Link to="/register" className="px-5 py-2.5 rounded-md bg-brand-green text-white hover:bg-green-600">Register</Link>
                </div>
              </div>
              <div className="bg-white rounded-xl shadow-lg p-6 border border-gray-100">
                <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
                  <div className="p-4 rounded-lg bg-blue-50">
                    <h3 className="font-semibold text-brand-blue">Device Risk Checker</h3>
                    <p className="text-sm text-gray-600 mt-2">Assess device risk probability by device and manufacturer.</p>
                  </div>
                  <div className="p-4 rounded-lg bg-green-50">
                    <h3 className="font-semibold text-brand-green">Manufacturer Insights</h3>
                    <p className="text-sm text-gray-600 mt-2">Identify patterns and improve device quality.</p>
                  </div>
                  <div className="p-4 rounded-lg bg-yellow-50">
                    <h3 className="font-semibold text-brand-yellow">Fault Reduction</h3>
                    <p className="text-sm text-gray-600 mt-2">Use feedback loops to reduce high-risk outcomes.</p>
                  </div>
                </div>
              </div>
            </div>
          </section>
        </div>
      );
    }

    function Register() {
      const backend = useBackend();
      const navigate = useNavigate();
      const [loading, setLoading] = useState(false);
      const [role, setRole] = useState('user');
      const [form, setForm] = useState({ username: '', email: '', password: '', company_name: '' });

      const submit = async () => {
        try {
          setLoading(true);
          const payload = {
            username: sanitize(form.username),
            email: sanitize(form.email),
            password: form.password,
          };
          if (role === 'manufacturer') payload.company_name = sanitize(form.company_name);
          const endpointIsManufacturer = role === 'manufacturer';
          await backend.register(payload, endpointIsManufacturer);
          toast.success('Registration successful. Please login.');
          navigate('/login');
        } catch (e) {
          const msg = e?.response?.data?.detail || 'Registration failed';
          toast.error(msg);
        } finally { setLoading(false); }
      };

      return (
        <div className="max-w-md mx-auto mt-10">
          <div className="bg-white rounded-lg shadow-lg p-6 border border-gray-100">
            <h2 className="text-2xl font-semibold text-brand-blue">Create an account</h2>
            <p className="text-sm text-gray-600 mt-1">Choose role: Medical or Manufacturer</p>
            <div className="mt-4 space-y-3">
              <div>
                <label className="block text-sm">Username</label>
                <input value={form.username} onChange={(e)=>setForm({...form, username:e.target.value})} className="mt-1 w-full border rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-brand-blue" placeholder="john_doe" />
              </div>
              <div>
                <label className="block text-sm">Email</label>
                <input type="email" value={form.email} onChange={(e)=>setForm({...form, email:e.target.value})} className="mt-1 w-full border rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-brand-blue" placeholder="you@example.com" />
              </div>
              <div>
                <label className="block text-sm">Password</label>
                <input type="password" value={form.password} onChange={(e)=>setForm({...form, password:e.target.value})} className="mt-1 w-full border rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-brand-blue" placeholder="••••••••" />
              </div>
              <div>
                <label className="block text-sm">Role</label>
                <select value={role} onChange={(e)=>setRole(e.target.value)} className="mt-1 w-full border rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-brand-blue">
                  <option value="user">Medical</option>
                  <option value="manufacturer">Manufacturer</option>
                </select>
              </div>
              {role === 'manufacturer' && (
                <div>
                  <label className="block text-sm">Company Name</label>
                  <input value={form.company_name} onChange={(e)=>setForm({...form, company_name:e.target.value})} className="mt-1 w-full border rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-brand-blue" placeholder="Acme Medical Inc." />
                </div>
              )}
              <button type="button" onClick={submit} disabled={loading} className="w-full mt-2 px-4 py-2 rounded-md bg-brand-green text-white hover:bg-green-600 disabled:opacity-50">
                {loading ? 'Creating account...' : 'Register'}
              </button>
            </div>
          </div>
        </div>
      );
    }

    function Login() {
      const backend = useBackend();
      const { login } = useAuth();
      const navigate = useNavigate();
      const [loading, setLoading] = useState(false);
      const [role, setRole] = useState('user');
      const [form, setForm] = useState({ username: '', password: '' });

      const submit = async () => {
        try {
          setLoading(true);
          const params = new URLSearchParams();
          params.append('username', sanitize(form.username));
          params.append('password', form.password);
          const isManufacturer = role === 'manufacturer';
          const { data } = await backend.login(params, isManufacturer);
          const token = data?.access_token || data?.token;
          if (!token) throw new Error('No token received');
          login({ token, role: isManufacturer ? 'manufacturer' : 'user', username: form.username, company_name: data?.company_name });
          toast.success('Login successful');
          navigate(isManufacturer ? '/manufacturer-dashboard' : '/medical-dashboard');
        } catch (e) {
          const status = e?.response?.status;
          if (status === 401) toast.error('Invalid credentials');
          else toast.error('Login failed');
        } finally { setLoading(false); }
      };

      return (
        <div className="max-w-md mx-auto mt-10">
          <div className="bg-white rounded-lg shadow-lg p-6 border border-gray-100">
            <h2 className="text-2xl font-semibold text-brand-blue">Sign in</h2>
            <div className="mt-4 space-y-3">
              <div>
                <label className="block text-sm">Username</label>
                <input value={form.username} onChange={(e)=>setForm({...form, username:e.target.value})} className="mt-1 w-full border rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-brand-blue" placeholder="john_doe" />
              </div>
              <div>
                <label className="block text-sm">Password</label>
                <input type="password" value={form.password} onChange={(e)=>setForm({...form, password:e.target.value})} className="mt-1 w-full border rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-brand-blue" placeholder="••••••••" />
              </div>
              <div>
                <label className="block text-sm">Role</label>
                <select value={role} onChange={(e)=>setRole(e.target.value)} className="mt-1 w-full border rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-brand-blue">
                  <option value="user">Medical</option>
                  <option value="manufacturer">Manufacturer</option>
                </select>
              </div>
              <button type="button" onClick={submit} disabled={loading} className="w-full mt-2 px-4 py-2 rounded-md bg-brand-blue text-white hover:bg-blue-700 disabled:opacity-50">
                {loading ? 'Signing in...' : 'Login'}
              </button>
            </div>
          </div>
        </div>
      );
    }

    function MedicalDashboard() {
      const { user } = useAuth();
      const backend = useBackend();
      const [devices, setDevices] = useState([]);
      useEffect(() => { (async () => {
        try { const { data } = await backend.devices(); setDevices(data || []); } catch { setDevices([]); }
      })(); }, []);
      const myDevices = devices.filter(d => d.username === user?.username || !d.username);
      return (
        <div className="max-w-7xl mx-auto px-4 mt-8">
          <h2 className="text-2xl font-semibold text-brand-blue">Welcome, {user?.username || 'Medical User'}</h2>
          <div className="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6">
            <Link to="/device-risk-checker" className="block p-6 bg-white rounded-lg shadow-md hover:shadow-lg border border-gray-100">
              <h3 className="text-lg font-semibold">Device Risk Checker</h3>
              <p className="text-sm text-gray-600 mt-2">Quickly assess device risk by manufacturer and name.</p>
            </Link>
            <div className="p-6 bg-white rounded-lg shadow-md border border-gray-100">
              <h3 className="text-lg font-semibold">Recent Activity</h3>
              <div className="mt-3 overflow-auto">
                <table className="w-full table-auto text-sm">
                  <thead>
                    <tr className="text-left bg-gray-50">
                      <th className="p-2">Device</th>
                      <th className="p-2">Manufacturer</th>
                      <th className="p-2">Risk</th>
                      <th className="p-2">Date</th>
                    </tr>
                  </thead>
                  <tbody>
                    {myDevices.slice(0,6).map((d)=> (
                      <tr key={d._id} className="border-t hover:bg-gray-50">
                        <td className="p-2">{d.device_name}</td>
                        <td className="p-2">{d.manufacturer_name}</td>
                        <td className="p-2">
                          <span className={`px-2 py-1 rounded text-white ${d.risk_class==='High'?'bg-brand-red':d.risk_class==='Medium'?'bg-brand-yellow text-black':'bg-brand-green'}`}>{d.risk_class}</span>
                        </td>
                        <td className="p-2">{new Date(d.created_at).toLocaleString()}</td>
                      </tr>
                    ))}
                    {myDevices.length===0 && (
                      <tr><td className="p-3 text-gray-500" colSpan="4">No recent activity</td></tr>
                    )}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      );
    }

    function DeviceRiskChecker() {
      const backend = useBackend();
      const navigate = useNavigate();
      const [manufacturerName, setManufacturerName] = useState('');
      const [deviceName, setDeviceName] = useState('');
      const [devices, setDevices] = useState([]);

      useEffect(() => { (async () => {
        try { const { data } = await backend.devices(); setDevices(Array.isArray(data)?data:[]); } catch { setDevices([]); }
      })(); }, []);

      const manufacturers = [...new Set(devices.map(d => d.manufacturer_name).filter(Boolean))];

      const submit = async () => {
        const device_name = sanitize(deviceName);
        const manufacturer_name = sanitize(manufacturerName);
        if (!device_name || !manufacturer_name) { toast.error('Please enter both device and manufacturer names.'); return; }
        try {
          const { data } = await backend.predict({ device_name, manufacturer_name });
          localStorage.setItem('lastPrediction', JSON.stringify(data));
          toast.success('Prediction ready');
          navigate('/risk-result');
        } catch (e) {
          const status = e?.response?.status;
          if (status === 401) redirectToLogin();
          else toast.error('Prediction failed');
        }
      };

      return (
        <div className="max-w-5xl mx-auto px-4 mt-8">
          <div className="bg-white rounded-lg shadow-md p-6 border border-gray-100">
            <h2 className="text-xl font-semibold text-brand-blue">Device Risk Checker</h2>
            <div className="mt-4 grid md:grid-cols-2 gap-4">
              <div>
                <label className="block text-sm">Manufacturer Name</label>
                <input list="manufacturers" value={manufacturerName} onChange={(e)=>setManufacturerName(e.target.value)} className="mt-1 w-full border rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-brand-blue" placeholder="e.g., MediTech" />
                <datalist id="manufacturers">
                  {manufacturers.map((m)=>(<option key={m} value={m} />))}
                </datalist>
              </div>
              <div>
                <label className="block text-sm">Device Name</label>
                <input value={deviceName} onChange={(e)=>setDeviceName(e.target.value)} className="mt-1 w-full border rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-brand-blue" placeholder="e.g., CardioMon 3000" />
              </div>
            </div>
            <button type="button" onClick={submit} className="mt-4 px-5 py-2 rounded-md bg-brand-green text-white hover:bg-green-600">Assess Risk</button>
          </div>

          <div className="mt-6 bg-white rounded-lg shadow-md p-6 border border-gray-100">
            <h3 className="text-lg font-semibold">Recent Risk Checks</h3>
            <div className="mt-3 overflow-auto">
              <table className="w-full table-auto text-sm">
                <thead>
                  <tr className="text-left bg-gray-50">
                    <th className="p-2">Device Name</th>
                    <th className="p-2">Manufacturer</th>
                    <th className="p-2">Risk Class</th>
                    <th className="p-2">Date</th>
                  </tr>
                </thead>
                <tbody>
                  {devices.slice(0,10).map((d)=> (
                    <tr key={d._id} className="border-t hover:bg-gray-50">
                      <td className="p-2">{d.device_name}</td>
                      <td className="p-2">{d.manufacturer_name}</td>
                      <td className="p-2">{d.risk_class}</td>
                      <td className="p-2">{new Date(d.created_at).toLocaleString()}</td>
                    </tr>
                  ))}
                  {devices.length===0 && (<tr><td className="p-3 text-gray-500" colSpan="4">No records</td></tr>)}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      );
    }

    function RiskChart({ type, dataConfig, options, className }) {
      const canvasRef = useRef(null);
      const chartRef = useRef(null);

      useEffect(() => {
        const ctx = canvasRef.current.getContext('2d');
        if (chartRef.current) chartRef.current.destroy();
        chartRef.current = new Chart(ctx, { type, data: dataConfig, options });
        return () => { if (chartRef.current) chartRef.current.destroy(); };
      }, [type, JSON.stringify(dataConfig), JSON.stringify(options)]);

      return <canvas ref={canvasRef} className={className} />;
    }

    function FeedbackForm({ deviceId, predictedRisk }) {
      const backend = useBackend();
      const { user } = useAuth();
      const [rating, setRating] = useState('');
      const [feedback, setFeedback] = useState('');
      const [actualRisk, setActualRisk] = useState('');
      const [loading, setLoading] = useState(false);

      if (user?.role !== 'manufacturer' || !deviceId) return null;

      const submit = async () => {
        if (!rating) { toast.error('Please select a rating'); return; }
        try {
          setLoading(true);
          const payload = { user_rating: Number(rating), user_feedback: sanitize(feedback), predicted_risk: predictedRisk, actual_risk: actualRisk || undefined };
          await backend.feedback(deviceId, payload);
          toast.success('Feedback submitted');
          setRating(''); setFeedback(''); setActualRisk('');
        } catch (e) {
          const status = e?.response?.status;
          if (status === 401) redirectToLogin();
          else if (status === 403) toast.error('Not allowed');
          else toast.error('Failed to submit feedback');
        } finally { setLoading(false); }
      };

      return (
        <div className="mt-6 bg-white rounded-lg shadow-md p-6 border border-gray-100">
          <h3 className="text-lg font-semibold">Provide Feedback</h3>
          <div className="mt-3 grid md:grid-cols-3 gap-4">
            <div>
              <label className="block text-sm">Rating</label>
              <select value={rating} onChange={(e)=>setRating(e.target.value)} className="mt-1 w-full border rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-brand-blue">
                <option value="">Select</option>
                {[1,2,3,4,5].map(n => <option key={n} value={n}>{n}</option>)}
              </select>
            </div>
            <div className="md:col-span-2">
              <label className="block text-sm">Feedback</label>
              <textarea value={feedback} onChange={(e)=>setFeedback(e.target.value)} rows="2" className="mt-1 w-full border rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-brand-blue" placeholder="Observations or comments..."></textarea>
            </div>
            <div>
              <label className="block text-sm">Actual Risk (optional)</label>
              <select value={actualRisk} onChange={(e)=>setActualRisk(e.target.value)} className="mt-1 w-full border rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-brand-blue">
                <option value="">Select</option>
                {['Low','Medium','High'].map(r => <option key={r} value={r}>{r}</option>)}
              </select>
            </div>
          </div>
          <button type="button" disabled={loading} onClick={submit} className="mt-4 px-5 py-2 rounded-md bg-brand-blue text-white hover:bg-blue-700 disabled:opacity-50">Submit Feedback</button>
        </div>
      );
    }

    function RiskAssessmentResult() {
      const { user } = useAuth();
      const [result, setResult] = useState(null);

      useEffect(() => {
        const raw = localStorage.getItem('lastPrediction');
        if (raw) {
          try { setResult(JSON.parse(raw)); } catch { setResult(null); }
        }
      }, []);

      if (!result) return (
        <div className="max-w-3xl mx-auto px-4 mt-10">
          <div className="bg-white rounded-lg shadow-md p-6 border border-gray-100">
            <p className="text-gray-600">No prediction result available. Please run a risk check.</p>
          </div>
        </div>
      );

      const colors = { Low: '#22C55E', Medium: '#FBBF24', High: '#EF4444' };
      const borderColors = { Low: '#14532D', Medium: '#854D0E', High: '#991B1B' };
      const probabilities = result.probabilities || { Low: 0, Medium: 0, High: 0 };
      const pieData = {
        labels: ['Low', 'Medium', 'High'],
        datasets: [{
          data: [probabilities.Low || 0, probabilities.Medium || 0, probabilities.High || 0],
          backgroundColor: [colors.Low, colors.Medium, colors.High],
          borderColor: [borderColors.Low, borderColors.Medium, borderColors.High],
          borderWidth: 1,
        }]
      };
      const pieOptions = {
        responsive: true, plugins: { legend: { position: 'top' }, title: { display: true, text: 'Risk Probability Breakdown' } }
      };

      return (
        <div className="max-w-4xl mx-auto px-4 mt-8">
          <div className="bg-white rounded-lg shadow-md p-6 border border-gray-100">
            <h2 className="text-xl font-semibold text-brand-blue">Risk Assessment Result</h2>
            <div className="mt-4 grid md:grid-cols-2 gap-6">
              <div className="space-y-2">
                <div><span className="text-sm text-gray-500">Device</span><p className="font-medium">{result.device_name}</p></div>
                <div><span className="text-sm text-gray-500">Manufacturer</span><p className="font-medium">{result.manufacturer_name}</p></div>
                <div>
                  <span className="text-sm text-gray-500">Risk Class</span>
                  <p className={`mt-1 inline-block px-2 py-1 rounded text-white ${result.risk_class==='High'?'bg-brand-red':result.risk_class==='Medium'?'bg-brand-yellow text-black':'bg-brand-green'}`}>
                    {result.risk_class} ({Number(result.risk_percent).toFixed(1)}%)
                  </p>
                </div>
              </div>
              <div>
                <RiskChart type="pie" dataConfig={pieData} options={pieOptions} className="max-w-sm" />
              </div>
            </div>

            <div className="mt-6">
              <h3 className="text-lg font-semibold">Suggested Alternatives</h3>
              <ul className="list-disc pl-6 mt-2 text-sm text-gray-700">
                {(result.suggested_alternatives || []).map((alt, idx) => (
                  <li key={idx}>{alt}</li>
                ))}
                {(!result.suggested_alternatives || result.suggested_alternatives.length===0) && <li className="list-none text-gray-500">No alternatives provided</li>}
              </ul>
            </div>

            <FeedbackForm deviceId={result._id} predictedRisk={result.risk_class} />
          </div>
        </div>
      );
    }

    function ManufacturerDashboard() {
      const { user } = useAuth();
      const backend = useBackend();
      const [devices, setDevices] = useState([]);

      useEffect(() => { (async () => {
        try { const { data } = await backend.devices(); setDevices(Array.isArray(data)?data:[]); } catch { setDevices([]); }
      })(); }, []);

      const myDevices = devices.filter(d => (d.manufacturer_name || '').toLowerCase() === (user?.company_name || '').toLowerCase());
      const counts = myDevices.reduce((acc, d) => { acc[d.risk_class] = (acc[d.risk_class]||0)+1; return acc; }, { Low:0, Medium:0, High:0 });
      const barData = {
        labels: ['Low Risk', 'Medium Risk', 'High Risk'],
        datasets: [{ label: 'Device Count', data: [counts.Low||0, counts.Medium||0, counts.High||0], backgroundColor: ['#22C55E','#FBBF24','#EF4444'], borderColor: ['#14532D','#854D0E','#991B1B'], borderWidth: 1 }]
      };
      const barOptions = { responsive: true, plugins: { legend: { position: 'top' }, title: { display: true, text: 'Device Risk Distribution' } }, scales: { y: { beginAtZero: true } } };

      return (
        <div className="max-w-7xl mx-auto px-4 mt-8">
          <h2 className="text-2xl font-semibold text-brand-blue">Welcome, {user?.company_name || 'Manufacturer'}</h2>
          <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mt-6">
            <div className="md:col-span-2 bg-white rounded-lg shadow-md p-6 border border-gray-100">
              <h3 className="text-lg font-semibold">Risk Distribution</h3>
              <RiskChart type="bar" dataConfig={barData} options={barOptions} />
            </div>
            <div className="bg-white rounded-lg shadow-md p-6 border border-gray-100">
              <h3 className="text-lg font-semibold">High-risk Alerts</h3>
              <ul className="mt-3 space-y-2">
                {myDevices.filter(d=>d.risk_class==='High').slice(0,5).map(d => (
                  <li key={d._id} className="p-3 rounded-md bg-red-50 border border-red-200 text-sm">
                    <span className="font-medium text-brand-red">{d.device_name}</span>
                    <div className="text-gray-600">{new Date(d.created_at).toLocaleString()}</div>
                  </li>
                ))}
                {myDevices.filter(d=>d.risk_class==='High').length===0 && <li className="text-sm text-gray-500">No high-risk devices</li>}
              </ul>
            </div>
          </div>

          <div className="mt-6 bg-white rounded-lg shadow-md p-6 border border-gray-100">
            <h3 className="text-lg font-semibold">Devices</h3>
            <div className="mt-3 overflow-auto">
              <table className="w-full table-auto text-sm">
                <thead>
                  <tr className="text-left bg-gray-50">
                    <th className="p-2">Device</th>
                    <th className="p-2">Risk</th>
                    <th className="p-2">Created</th>
                  </tr>
                </thead>
                <tbody>
                  {myDevices.map(d => (
                    <tr key={d._id} className="border-t hover:bg-gray-50">
                      <td className="p-2">{d.device_name}</td>
                      <td className="p-2"><span className={`px-2 py-1 rounded text-white ${d.risk_class==='High'?'bg-brand-red':d.risk_class==='Medium'?'bg-brand-yellow text-black':'bg-brand-green'}`}>{d.risk_class}</span></td>
                      <td className="p-2">{new Date(d.created_at).toLocaleString()}</td>
                    </tr>
                  ))}
                  {myDevices.length===0 && (<tr><td className="p-3 text-gray-500" colSpan="3">No devices</td></tr>)}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      );
    }

    function ProtectedRoute({ roles, children }) {
      const { user } = useAuth();
      if (!getToken() || !user) return <Navigate to="/login" replace />;
      if (roles && !roles.includes(user.role)) return <Navigate to="/login" replace />;
      return children;
    }

    function App() {
      return (
        <HashRouter>
          <AuthProvider>
            <Header />
            <main className="min-h-[70vh]">
              <Routes>
                <Route path="/" element={<Landing />} />
                <Route path="/login" element={<Login />} />
                <Route path="/register" element={<Register />} />
                <Route path="/medical-dashboard" element={<ProtectedRoute roles={['user']}><MedicalDashboard /></ProtectedRoute>} />
                <Route path="/device-risk-checker" element={<ProtectedRoute roles={['user']}><DeviceRiskChecker /></ProtectedRoute>} />
                <Route path="/risk-result" element={<ProtectedRoute roles={['user','manufacturer']}><RiskAssessmentResult /></ProtectedRoute>} />
                <Route path="/manufacturer-dashboard" element={<ProtectedRoute roles={['manufacturer']}><ManufacturerDashboard /></ProtectedRoute>} />
                <Route path="*" element={<Navigate to="/" replace />} />
              </Routes>
            </main>
            <Footer />
            <ToastContainer position="top-right" autoClose={2500} hideProgressBar closeOnClick pauseOnHover theme="colored" />
          </AuthProvider>
        </HashRouter>
      );
    }

    const Root = () => (
      <BackendProvider>
        <App />
      </BackendProvider>
    );

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<Root />);
  </script>
</body>
</html>